# Обратная маршрутизация

Обратная маршрутизация (`reverse routing`) - это генерация URI/URL из маршрута. Т.е. это механизм, обратный классическому
 преобразованию адреса в массив параметров. Самый быстрый способ понять его - рассмотреть несколько примеров:

    // получаем полный URL из дефолтного маршрута (что-то вроде http://example.com/foo/bar)
    echo Route::url('default', array('controller' => 'foo', 'action' => 'bar'), 'http');
    // получаем URI (foo/bar)
    echo Route::get('default')->uri(array('controller' => 'foo', 'action' => 'bar'));

Для получения абсолютного адреса используется статический метод `Route::url()`, который принимает имя используемого маршрута,
 сегменты для подстановки, и используемый протокол.

[!!] Работа метода `Route::url()` с протоколом полностью аналогична методу `URL::base()`. Т.е. если передано значение TRUE, то
 будет использован протокол из стартового URL, либо можно передать целый объект `Request` и протокол будет взят из него.

## Внешние маршруты

В версии **3.1** впервые появились внешние запросы, т.е. запросы к приложениям на других серверах. В **Kohana** такими считаются
 любые запросы, содержащие в себе протокол (т.е. `http://`, `https://` и т.д.). Естественно, стартовый запрос внешним быть
 не может.

Так, `Request::factory('http://github.com/kohana/kohana')` создаст внешний запрос к репозиторию **Kohana** на **Github**'е.

Пример использования:

    // получаем объект Response от выполнения запроса к Яндексу
    $data = Request::factory('http://yandex.ru')->execute();

Для обработки внешних запросов были созданы внешние маршруты. Главное их отличие от внутренних - они имеют параметр
 установленный `host`.

[!!] Если быть точным, то значение сегмента `host` не должно присутствовать в свойстве `Route::$localhosts`. По умолчанию
 там перечислены значения `FALSE`, `''`, `'local'` и `'localhost'`. Поменять эти значения на свои можно стандартным способом -
 создайте файл `application/classes/route.php` (естественно, он должен быть потомком класса `Kohana_Route`) и в нем поменяйте
 свойство `$_defaults`.

Проверить любой маршрут можно с помощью метода `is_external()`.

Пример внешнего маршрута:

    $route = Route::set('github', '<username>(/<repo>)')
        ->defaults(array(
            'host' => 'github.com',
        ));
    if ($route->is_external()) {...}

С помощью данного маршрута удобно генерировать ссылки на страницы проектов Github:

    // вернет ссылку 'http://github.com/kohana/userguide'
    Route::url('github', array('username' => 'kohana', 'repo' => 'userguide'));

Впрочем, есть и ложка дегтя. К сожалению, текущая версия **Kohana** не умеет отсеивать внешние маршруты при обработке "своего"
 URI. Например, маршрут 'github' обработает адреса вида 'welcome/index', и мы получим ошибку "параметр controller не найден".
 В связи с этим, вероятно самый грамотный способ использовать внешние маршруты - объявлять их после всех внутренних. Например,
 после catch-all маршрута или уже где-нибудь в базовом контроллере.

[!!] Подобные ограничения практически сводят на нет любые плюсы внешних маршрутов. На данный момент проще сделать внешний
 *reverse routing* с помощью отдельного хэлпера.