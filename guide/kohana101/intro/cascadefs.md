# Каскадная файловая система

## Описание

Каскадная файловая система **Kohana** (КФС) - это очень удобный механизм для создания гибких и легко расширяемых проектов.
 Для лучшего понимания ее принципов приведем изображение из [Kohana Userguide](http://kohanaframework.org/3.2/guide/):

![Каскадная файловая система](http://kohanaframework.org/3.2/guide/media/kohana/cascading_filesystem.png)

Как мы помним, проект состоит из трех основных директорий - `application`, `modules` (если подключены модули) и `system`.
 Что, если у нас есть класс `Kohana_Cookie` (т.е. файл `classes/kohana/cookie.php`) в нескольких из них? Чтобы не было конфликтов,
 **Kohana** использует следующие приоритеты при поиске файла:

 1. `application`. Если файл найден тут, дальнейший поиск прекращается.
 2. `modules`. Каждый подключенный модуль проверяется на наличие искомого файла.
 3. `system`. Сюда **Kohana** заглядывает в самый последний момент. Таким образом, любой файл ядра, переопределенный в директории
  верхнего уровня (`application` или `modules`), будет браться именно из нового места.

[!!] Это актуально для всех типов файлов, кроме [конфигурационных](intro/config), [i18n-файлов](basic/i18n/i18n) и [сообщений](basic/i18n/messages).
 Такие файлы не переопределяют друг друга, а *объединяются*.

## Поиск внутри модулей

Так как модулей может быть несколько, среди них тоже необходимо расставить приоритеты. Важен порядок, в котором модули были
 добавлены к проекту (см. [Kohana::modules] в `application/bootstrap.php`). Чем раньше был модуль объявлен, тем раньше он
 будет участвовать в поиске файла.

## Применение

В первую очередь это необходимо, чтобы можно было изменить работу объектов без непосредственной модификации оригинала. Например,
 пусть мы хотим добавить в тот самый класс `Kohana_Cookie` свою функцию или поменять работу одного из существующих методов.
 Нам понадобится просто скопировать оригинальный файл `system/classes/kohana/cookie.php` в `application/classes/kohana/` и
 отредактировать под свои нужды. Так как в итоге КФС загрузит класс из директории верхнего уровня (`application`), то новый
 функционал появится, и при этом старый файл останется нетронутым.

## Классы-пустышки

У предыдущего способа есть серьезный недостаток. Если в последующих версиях фреймворка что-то поменяется в файле
 `system/classes/kohana/cookie.php`, то нам придется переносить эти изменения в новый файл (директория `application`). Чтобы
 облегчить подобные модификации, в ядро и модули **Kohana** добавлены классы-пустышки:

    // файл system/classes/cookie.php
    class Cookie extends Kohana_Cookie {}

    // файл system/classes/kohana/cookie.php
    class Kohana_Cookie { ... }

Таким образом, на сайте используется короткое имя класса (`Cookie`), но весь функционал лежит в `Kohana_Cookie`. Так что можно
 легко изменить поведение `Kohana_Cookie`. При этом нам не надо дублировать содержимое `Kohana_Cookie`, добавляется только
 то, что отличается от оригинала.

## Поиск файлов

Для поиска файлов используется метод [Kohana::find_files]:

    public static function find_file($dir, $file, $ext = NULL, $array = FALSE)

`$dir`   - имя директории для поиска (относительно унифицированной структуры директорий, например `classes/model` или `views`).
`$file`  - оставшееся имя файла
`$ext`   - расширение файла (по умолчанию берется из константы `EXT`, см. файл `index.php`)
`$array` - флаг, отвечающий за формат результата. Если `TRUE`, то вернутся все найденные пути. Если `FALSE`, то самый первый.

[!!] Если вам удобнее указывать расширение в имени файла, то для `$ext` передавайте `FALSE`

Вот несколько примеров поиска:

     // ищем контроллер welcome
     Kohana::find_file('classes/controller', 'welcome');
     // ищем конфигурационные файлы для модуля Database
     Kohana::find_file('config', 'database', NULL, TRUE);

Если файл не найден, то возвращается `FALSE`. Если найдено несколько файлов, то в массиве они будут отсортированы в порядке,
 обратном описанному выше приоритету. Т.е. файл из `application` будет последним.

[!!] Для ускорения работы результаты поиска кешируются в файловой системе. Для этого надо при [инициализации ядра](intro/settings)
 передать в [Kohana::init] параметр `caching=TRUE` (см. файл `application/bootstrap.php`)

