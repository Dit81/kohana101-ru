# Контроллер

Контроллер - это объект, который предназначен для контроля работы приложения. Он обрабатывает внешние обращения, на их
 основе изменяет состояние [модели](intro/mvc/model), а результаты отдает на отображение [представлению](intro/mvc/view).

## Файлы контроллеров Kohana

Все контроллеры должны располагаться в директориях `controller` файловой системы **Kohana**. Имена файлов состоят из букв
 в нижнем регистре. Разрешено использовать поддиректории. Имя класса контроллера определяется его расположением относительно
 директории `controller`:

 Имя класса                | Путь к файлу
-------------------------- | -----------------------------------------
 `Controller_Welcome`      | `classes/controller/welcome.php`
 `Controller_Foo`          | `classes/controller/foo.php`
 `Controller_Foo_Bar`      | `classes/controller/foo/bar.php`
 `Controller_Foo_Bar_Baz`  | `classes/controller/foo/bar/baz.php`

## Базовый класс Controller

В **Kohana** имеется абстрактный класс `Controller`, от которого должны быть унаследованы все наши контроллеры. В нем
 реализованы базовые возможности контроллера:

 * создание объектов [request](basic/request) и [response](basic/response) в виде публичных свойств `$request` и `$response`
 * специальные методы `before()` и `after()`

## Имена методов контроллера

Для методов, доступных извне (т.е. которые можно вызвать напрямую через URL), существует обязательно требование - они
 должны начинаться на префикс `action_`. Например, дефолтный метод будет называться `action_index()`. Естественно, они должны
 быть публичными (`public`).

[!!] Очень часто такие методы называют "экшенами", из-за стандартного префикса.

Все прочие методы автоматически становятся внутренними методами контроллера. Их можно использовать для вызова
 различных служебных расчетов или проверок из экшенов.

### Специальные методы before() и after()

В версии 2.x мы могли использовать только конструктор контроллера, чтобы выполнить какие-либо предварительные манипуляции
 (инициализация свойств, проверка прав доступа и т.д.). В ветке 3.x решено использовать специальные методы, которые будут
 вызываться до запрошенного экшена (метод `before()`) и по окончании его работы (метод `after()`).

Выглядит это примерно так:

    public function before()
    {
        // не забываем вызывать родительский метод!
        parent::before();
        $this->_session = Session::instance();
    }

    public function after()
    {
        if (empty($this->template->title))
        {
            $this->template->title = 'Заголовок по умолчанию';
        }

        // родительский метод вызываем после собственных манипуляций
        parent::after();
    }

[!!] методы `before()` и `after()` вызываются без параметров, и ничего не возвращают.

[!!] Одно из полезных свойств метода `before` заключается в том, что мы можем в нем изменить имя выполняемого экшена.

## Класс Controller_Template

Обычно контроллер передает результаты своей работы (в том числе и данные от модели) в представление. В связи с этим
 фреймворк предлагает заранее созданный шаблон контроллера, работающего с представлениями. Это класс `Controller_Template`.
 В нем добавлены следующие важные свойства:

 * `$template` - имя базового представления, с которым работает контроллер
 * `$auto_render` - если **TRUE** (это значение по умолчанию), то содержимое представления `$this->template` будет автоматически
   отправлено в качестве [ответа](basic/response) на запрос.

Таким образом, простейший контроллер с поддержкой представлений может выглядеть примерно так:

    class Controller_Home extends Controller_Template {

        // установили в качестве базового шаблона файл views/home.php
        public $template = 'home';

        public function action_index() {
            // внутрь базового шаблона подкладываем еще одно представление
            $this->template->content = View::factory('content');
        }
    }

Обратите внимание, что в самом классе свойство `$template` является строкой, а в методах контроллера мы обращаемся к нему
 как к объекту. Дело в том, что в методе `before()` класса `Controller_Template` на основании значения `$template` создается
 представление, которое в это же свойство и сохраняется.

[!!] Если в дальнейшем потребуется поменять базовый шаблон, используйте метод `set_filename()`. Так вы не потеряете сохраненные
 в шаблоне переменные и вложенные представления: `$this->template->set_filename('alternate');`


