# Модели Auth ORM

В комплекте модуля **ORM** идут несколько моделей, которые можно использовать для работы с модулем **Auth**.

[!!] Несмотря на то, что ниже описываются "короткие" классы (`Model_User`, `Model_Role` и тд), весь код размещается в родительских
 классах (`Model_Auth_User`, `Model_Auth_Role`). Таким образом, можно просто скопировать файл модели `Model_User` в `APPPATH`
 и добавить новые возможности, не теряя оригинальных. Либо использовать существующую (свою) модель, сделав ее потомком `Model_Auth_User`.

Предусмотрена следующая схема работы:

 * Пользователь может иметь несколько ролей, одна и та же роль может быть назначена нескольким пользователям (Many-To-Many)
 * При использовании "запоминания" к пользователю привязывается новый токен. Их может быть несколько, но каждый токен может
    иметь только одного владельца

## Model_User

Это основная модель, и она позволяет работать с объектом "пользователь".

 * Пароль всегда хранится в виде хэша. Во время записи "сырого" значения пароля в поле `password` отрабатывает специальный
    фильтр, вызывающий метод [Auth::hash].
 * Предполагается наличие двух уникальных полей (кроме `id`): `username` и `email`. Для проверки на их уникальность в модели
    созданы методы `unique_key($value)` и `unique_key_exists($value, $field)`. Первый позволяет по переданному значению
    `$value` определить полей (`username` или `email`), второй уже проверяет значение `$value` поля `$field` на уникальность.
 * Для создания и обновления пользователей созданы методы `create_user($values, $expected)` и `update_user($values, $expected)`.
    В них передаются массив значений полей (например `$_POST`) и массив названий полей, которые ожидаются для заполнения.
    Если не передавать `$expected`, то любой поле модели можно будет поменять. В этих методах автоматически добавляется
    сравнение полей `password` и `password_confirm`.
 * Если при обновлении модели не передан пароль (или в нем пустое значение), в БД останется сохранено старое значение.
 * В модели есть специальные поля `logins` и `last_login`. Это счетчик успешных аутентификаций и метка времени последнего
    входа. Они обновляются автоматически.

## Model_Role

Модель используется для справочника ролей.

 * Изначально модуль **Auth** предлагает две роли - `admin` и `login`.
 * Название роли по умолчанию должно быть длиной от 4 до 32 символов.

## Model_User_Token

Модель используется в механизме "[запоминания](auth/orm/autologin)".

 * Сам токен генерируется автоматически (метод [Model_User_Token::create_token]). Каждый токен уникален.
 * По умолчанию срок жизни токена - 2 недели.
 * Время от времени старые токены удаляются. Запрос на удаление генерируется случайным образом, примерно на каждое сотое
    создание токена.
 * Для идентификации пользователя сохраняется хеш (с помощью `sha1()`) его `User Agent`.